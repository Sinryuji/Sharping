<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybaits.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="orderDAO">
	
	<insert id="insertVirtualAccount" parameterType="virtualAccountVO">
		INSERT INTO VIRTUALACCOUNT VALUES(#{vaNum},#{orderNum},#{bankCode},#{payPrice},#{respCode},sysdate)
	
	</insert>
	
	<select id="selectOrder" resultType="orderVO">
		SELECT * FROM ORDERR WHERE "orderNum" = #{orderNum}
	</select>
	
	<select id="selectByVirtualAccount" resultType="payBankVO">
		SELECT * FROM VIRTUALACCOUNT WHERE "orderNum" = #{orderNum}
	</select>
	
	<insert id="insertPayBank" parameterType="payBankVO">
		INSERT INTO PAYBANK VALUES(#{orderNum},'','',#{bankCode},#{vaNum})
		
	</insert>
	
	<select id="selectPayBank" resultType="payBankVO">
		SELECT * FROM PAYBANK WHERE "orderNum" = #{orderNum}
	</select>
	
	<update id="updateRespCode" parameterType="payMoneyVO" >
		UPDATE VIRTUALACCOUNT SET "respCode" = 'YES' WHERE "vaNum" = #{vaNum} and "bankCode" = #{bankCode} and "payPrice" = #{payPrice}
	</update>
	
	<update id="updatepayDate" parameterType="int">
		UPDATE PAYBANK SET "payDate" = sysdate
	</update>
	
	<update id="updateState" parameterType="int">
		UPDATE ORDERR SET "state" = '결제 완료'
	</update>
	
	<select id="selectByBankVO" resultType="bankVO">
		SELECT * FROM BANK
	</select>
	
	
	<insert id="insertOrder" parameterType="orderVO">
		INSERT INTO ORDERR VALUES (ORDER_SEQ.NEXTVAL, SYSDATE, #{state}, #{payCase}, #{payPrice}, #{trackingNum}, #{toName}, #{toPhone}, #{toPost}, #{toAddress}, #{id}, #{deliveryMessage})
	</insert>

	<insert id="insertPayCard" parameterType="orderVO">
		INSERT INTO PAYCARD VALUES (#{orderNum}, #{impId})
	</insert>
	
	<select id="selectLatelyOrderNum" resultType="orderVO" parameterType="String">
		SELECT * FROM ORDERR WHERE "orderDate" = (SELECT MAX("orderDate") FROM ORDERR WHERE "id" = #{id})
	</select>
	
	<select id="selectTonameOrderNum" resultType="orderVO" parameterType="String">
		SELECT * FROM ORDERR WHERE "orderDate" = (SELECT MAX("orderDate") FROM ORDERR WHERE "toName" = #{toName})
	</select>
	
	<insert id="insertOrderList" parameterType="orderListVO">
		INSERT INTO ORDERLIST VALUES (ORDERLIST_SEQ.NEXTVAL, #{productName}, #{productThumb}, #{optionOneNum}, #{optionTwoNum}, #{optionThreeNum}, #{productPrice}, #{cnt}, #{orderNum}, #{optionNum})
	</insert>
	
	<update id="decrementStockProduct" parameterType="orderListVO">
		UPDATE PRODUCT SET "stock" = "stock" - #{cnt} WHERE "productNum" = #{productNum}
	</update>
	
	<update id="decrementStockOption" parameterType="orderListVO">
		UPDATE OPTIONN SET "stock" = "stock" - #{cnt} WHERE "optionNum" = #{optionNum}
	</update>
	
	<select id="selectProductNumByOptionNum" resultType="int" parameterType="int">
		SELECT "productNum" FROM OPTIONN WHERE "optionNum" = #{optionNum}
	</select>
	
	<insert id="insertGuest" parameterType="guestVO">
		INSERT INTO GUEST VALUES(#{orderNum},#{guestName},#{guestPhone},#{guestPassword})
	
	</insert>
	
	<select id="selectOrderByGuest" resultType="guestVO" parameterType="guestVO">
		SELECT * FROM GUEST WHERE "guestName" = #{guestName} and "guestPhone" = #{guestPhone} and "guestPassword" = #{guestPassword}
	</select>
	
	<select id="selectOrderListByorderNum" parameterType="hashmap" resultType="orderListVO">
		SELECT * FROM ORDERLIST l, ORDERR o	 where l."orderNum" = o."orderNum" and
		<foreach collection="array" item="orderNum" index="index" open="(" close=")" separator="OR">
			l."orderNum" = #{orderNum}
		</foreach>
		ORDER BY o."payCase" ASC
	</select>
	
	<select id="selectVirtualAccountVO" parameterType="hashmap" resultType="virtualAccountVO">
		SELECT * FROM VIRTUALACCOUNT 
		<foreach collection="array" item="orderNum" open="WHERE" separator="OR">
			"orderNum" = #{orderNum}
		</foreach>
		
	</select>
	
	<select id="selectOrderByorderNums" parameterType="hashmap" resultType="OrderVO">
			SELECT * FROM ORDERR 
		<foreach collection="array" item="orderNum" open="WHERE" separator="OR">
			"orderNum" = #{orderNum}
		</foreach>
		ORDER BY "payCase" ASC
	</select>
	<select id="selectPayCardByOrderNum" parameterType="Integer" resultType="Integer">
		SELECT * FROM ORDERR WHERE "payCase" = '카드' and
		<foreach collection="array" item="orderNum" open="(" close=")" separator="or">
			"orderNum" = #{orderNum}
		</foreach>
	</select>
	<select id="selectPayBankByOrderNum" parameterType="Integer" resultType="Integer">
		SELECT * FROM ORDERR WHERE "payCase" = '무통장 입금' and
		<foreach collection="array" item="orderNum" open="(" close=")" separator="or">
			"orderNum" = #{orderNum}
		</foreach>
	</select>
	<select id="selectBankName" parameterType="int" resultType="bankVO">
		SELECT * FROM BANK WHERE "bankCode" = #{bankCode}
	</select>
	
	

</mapper>